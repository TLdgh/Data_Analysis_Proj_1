```{r}
#packages used
require(maps)
require(plotly)
```

```{r}
#fill a matrix
ElectionPoll<-read.csv("polls_us_election_2016.csv", header = TRUE)
ElectionPoll$state<-toupper(ElectionPoll$state)
state_poll<- ElectionPoll %>%
  group_by(state) %>%
  summarise(rawpoll_clinton = mean(rawpoll_clinton), rawpoll_trump = mean(rawpoll_trump),adjpoll_clinton = mean(adjpoll_clinton), adjpoll_trump = mean(adjpoll_trump))
#delete useless data
state_poll<-state_poll[-50,]
state_poll<-state_poll[-c(31:33),]
state_poll<-state_poll[-c(21:22),]
colnames(state_poll)<-c("State","rawpoll_clinton","rawpoll_trump","adjpoll_clinton","adjpoll_trump","percent_rawpoll_clinton","percent_adjpoll_clinton")
```

```{r}
state_rawpoll<-data.frame(state_poll[,1:3])
state_adjpoll<-data.frame(state_poll[,1],state_poll[,4:5])
#add percent
state_rawpoll$percent_rawpoll_clinton<-100*state_poll$rawpoll_clinton/(state_poll$rawpoll_clinton+state_poll$rawpoll_trump)
state_adjpoll$percent_adjpoll_clinton<-100*state_poll$adjpoll_clinton/(state_poll$adjpoll_clinton+state_poll$adjpoll_trump)
```

```{r}
#get map data:
df <- read.csv("https://raw.githubusercontent.com/plotly/datasets/master/us-cities-top-1k.csv")
df<-distinct(df,State, .keep_all = TRUE)
df$State<-toupper(df$State)
df<-df[,-3]
df<-df[,-1]
states_map <- map_data(map = "state",region =df$State)

#get mean longitude and latitude
region.lab.data <- states_map %>%
  group_by(region) %>%
  summarise(lon = mean(long), lat = mean(lat))
region.lab.data$region<-toupper(region.lab.data$region)

region.lab.data[which(region.lab.data$region=="HAWAII"),]<-df[which(df$State=="HAWAII"),]
region.lab.data[which(region.lab.data$region=="ALASKA"),]<-df[which(df$State=="ALASKA"),]
colnames(region.lab.data)<-c("State","lat","lon")

df1<-merge(state_rawpoll,df, by.x = "State")
df_1<-merge(state_adjpoll,df, by.x = "State")
```


```{r}
#add code
df2<-read.csv("https://raw.githubusercontent.com/plotly/datasets/master/2011_us_ag_exports.csv")
df2<-distinct(df2,state, .keep_all = TRUE)
df2$state<-toupper(df2$state)
df2<-df2[, 1:2]
colnames(df2)<-c("Code", "State")
df2<-rbind(df2, data.frame(Code="DC", State="DISTRICT OF COLUMBIA"))

df3<-merge(df1, df2, by.x = "State")
df_3<-merge(df_1, df2, by.x = "State")
```

```{r}
#choropleth plot
g <- list(
  scope = 'usa',
  projection = list(type = 'albers usa')
)

plot_geo(df3, locationmode = 'USA-states')%>% 
  add_trace(
    z = ~percent_rawpoll_clinton, text = ~~paste(State,percent_rawpoll_clinton , sep = "<br />"), 
    locations = ~Code, color =~percent_rawpoll_clinton, colors=c('red','white','blue')
    )%>%
  colorbar(limits = c(0, 100),title = "Clinton's vote share(%)")%>%
  layout(title = 'Clinton and Trump vote share in 2016(rawpoll)', geo = g)

htmlwidgets::saveWidget(widget = boxchart, file = "mapchart1.html")
webshot::webshot(url = "mapchart1.html", file = "mapchart1.png", delay = 1, zoom = 4, vheight = 500)
```

```{r}
#adjpoll
g <- list(
  scope = 'usa',
  projection = list(type = 'albers usa')
)

plot_geo(df_3, locationmode = 'USA-states')%>% 
  add_trace(
    z = ~percent_adjpoll_clinton, text = ~~paste(State,percent_adjpoll_clinton , sep = "<br />"), 
    locations = ~Code, color =~percent_adjpoll_clinton, colors=c('red','white','blue')
    )%>%
  colorbar(limits = c(0, 100),title = "Clinton's vote share(%)")%>%
  layout(title = 'Clinton and Trump vote share in 2016(adjpoll)', geo = g)

htmlwidgets::saveWidget(widget = boxchart, file = "mapchart2.html") 
webshot::webshot(url = "mapchart2.html", file = "mapchart2.png", delay = 1, zoom = 4, vheight = 500)
```

