---
title: "Plot"
author:
- Teng Li(7373086)
- Shiya Gao(300381032)
- Chuhan Yue(300376046)
- Yang Lyu(8701121)
output: pdf_document
header-includes: 
  - \renewcommand{\and}{\\}
---

# Introduction
A data set of the 2016 US election polls was given. In this project we aim to understand the data structure by creating various visualizations.  

# Method
We use various R packages to present the data set and to plot the graphs.
```{r}
knitr::opts_chunk$set(echo = FALSE)
library(plotly)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(patchwork)
library(tidyr)
```
# Result
We first take a look at the raw data set:
```{r}
ElectionPoll<-read.csv("polls_us_election_2016.csv", header = TRUE)
```
As we can see, there are a few variables with missing values:
```{r}
summary(ElectionPoll)
```

```{r}
#Create frame contained time, rawpoll
start_time <- as.POSIXct(ElectionPoll$startdate)
end_time <- as.POSIXct(ElectionPoll$enddate)
prop_raw_clinton <- ElectionPoll$rawpoll_clinton
prop_raw_trump <- ElectionPoll$rawpoll_trump
prop_raw_johnson <- ElectionPoll$rawpoll_johnson
prop_raw_mcmullin <- ElectionPoll$rawpoll_mcmullin

poll_by_time <- data.frame( 
  start_time = start_time,
  end_time = end_time,
  clinton = prop_raw_clinton,
  trump = prop_raw_trump,
  johnson = prop_raw_johnson,
  mcmullin = prop_raw_mcmullin
)

head(poll_by_time)
# Order with increasing end_date
poll_by_time <- poll_by_time[order(poll_by_time$end_time, decreasing = FALSE),]
head(poll_by_time)
```
Without removing the missing values:
```{r}
# Plot trend with all four candidates's uncleaned data
g_1 <- ggplot(poll_by_time, aes(x = end_time)) +
  geom_line(aes(y = prop_raw_clinton, color = "Clinton"), alpha = 0.6) +
  geom_line(aes(y = prop_raw_trump, color = "Trump"), alpha = 0.6) +
  geom_line(aes(y = prop_raw_johnson, color = "Johnson"), alpha = 0.6) +
  geom_line(aes(y = prop_raw_mcmullin, color = "Mcmullin"), alpha = 0.6) +
  labs(x = "Date", y = "Proportion of rawpoll (%)", 
       title = "Raw Poll Proportion by Time",
       subtitle = "Clinton vs. Trump vs. Johnson vs. Mcmullin",
       caption = "Data: poll_by_time (with missing values)") +
  scale_color_manual(values = c("Clinton" = "blue", "Trump" = "red", "Johnson" = "green", "Mcmullin" = "yellow")) +
  scale_x_datetime(date_breaks = "2 month") +
  theme(axis.text.x = element_text(angle = 50, size = 7, vjust = 0.5)) + 
  theme(axis.title.x = element_text(size = 9, vjust = 0),
        axis.title.y = element_text(size = 9, vjust = 3)) +
  theme(plot.title = element_text(size = 12, face = "bold", 
                                  margin = margin(0, 0, 0, 0))) +
  theme(legend.title = element_blank()) +
  theme(legend.position = "bottom")
print(g_1)
```

Scatter plot with uncleaned date:

```{r}
# Plot trend with all four candidates's uncleaned data
g_2 <- ggplot(poll_by_time, aes(x = end_time)) +
  geom_point(aes(y = prop_raw_clinton, color = "Clinton"),size = 1, alpha = 0.3) +
  geom_point(aes(y = prop_raw_trump, color = "Trump"), size = 1, alpha = 0.3) +
  geom_point(aes(y = prop_raw_johnson, color = "Johnson"), size = 1, alpha = 0.3) +
  geom_point(aes(y = prop_raw_mcmullin, color = "Mcmullin"), size = 1, alpha = 0.3) +
  labs(x = "Date", y = "Proportion of rawpoll (%)", 
       title = "Raw Poll Proportion by Time", 
       subtitle = "Clinton vs. Trump vs. Johnson vs. Mcmullin", 
       caption = "Data: poll_by_time (with Missing Values)") +
  scale_color_manual(values = c("Clinton" = "blue", "Trump" = "red", "Johnson" = "green", "Mcmullin" = "yellow")) +
  scale_x_datetime(date_breaks = "2 month") +
  theme(axis.text.x = element_text(angle = 50, size = 7, vjust = 0.5)) + 
  theme(axis.title.x = element_text(size = 9, vjust = 0),
        axis.title.y = element_text(size = 9, vjust = 3)) +
  theme(plot.title = element_text(size = 12, face = "bold", 
                                  margin = margin(0, 0, 0, 0))) + 
  theme(legend.title = element_blank()) +
  theme(legend.position = "bottom")
print(g_2)
```

```{r}
g_2 + g_1
```


```{r}
# Plot trend with all four candidates's uncleaned data
g_3 <- ggplot(poll_by_time, aes(x = end_time)) +
  geom_smooth(aes(y = prop_raw_clinton, color = "Clinton")) +
  geom_smooth(aes(y = prop_raw_trump, color = "Trump")) +
  geom_smooth(aes(y = prop_raw_johnson, color = "Johnson")) +
  geom_smooth(aes(y = prop_raw_mcmullin, color = "Mcmullin")) +
  labs(x = "Date", y = "Proportion of rawpoll (%)", 
       title = "Raw Poll Proportion Trend by Time", 
       subtitle = "Clinton vs. Trump vs. Johnson vs. Mcmullin", 
       caption = "Data: poll_by_time (with Missing Values)") +
  scale_color_manual(values = c("Clinton" = "blue", "Trump" = "red", "Johnson" = "green", "Mcmullin" = "yellow")) +
  scale_x_datetime(date_breaks = "2 month") +
  theme(axis.text.x = element_text(angle = 50, size = 7, vjust = 0.5)) + 
  theme(axis.title.x = element_text(size = 9, vjust = 0),
        axis.title.y = element_text(size = 9, vjust = 3)) + 
  theme(plot.title = element_text(size = 12, face = "bold", 
                                  margin = margin(0, 0, 0, 0))) +
  theme(legend.title = element_blank()) +
  theme(legend.position = "bottom")
print(g_3)
```

Remove the missing values, count the row number of 4 candidates cleaned data:
```{r}
#Remove the missing values
poll_by_time_clean <- na.omit(poll_by_time)
# Count the row number of 4 candidates cleaned data
nrow(poll_by_time_clean)

start_time_clean <- as.POSIXct(poll_by_time_clean$start_time)
end_time_clean <- as.POSIXct(poll_by_time_clean$end_time)
prop_raw_clinton_clean <- poll_by_time_clean$clinton
prop_raw_trump_clean <- poll_by_time_clean$trump
prop_raw_johnson_clean <- poll_by_time_clean$johnson
prop_raw_mcmullin_clean <- poll_by_time_clean$mcmullin
```

Using the data with missing values deleted, a trend chart showing the change in the proportion of votes obtained by all four candidates over time is made.

```{r}
ggplot(poll_by_time_clean, aes(x = end_time_clean)) +
  geom_point(aes(y = prop_raw_clinton_clean, color = "Clinton")) +
  geom_point(aes(y = prop_raw_trump_clean, color = "Trump")) +
  geom_point(aes(y = prop_raw_johnson_clean, color = "Johnson")) +
  geom_point(aes(y = prop_raw_mcmullin_clean, color = "Mcmullin")) +
  labs(x = "Date", y = "Proportion of rawpoll") +
  scale_color_manual(values = c("Clinton" = "blue", "Trump" = "red", "Johnson" = "green", "Mcmullin" = "yellow")) +
  theme_minimal() + 
  ggtitle("Poll Proportion by Time 
          (without Missing Values)")
```

3 candidate's (Clinton, Trump and Johnson) trend by time with cleaned data.

```{r}
#Create 3 candidates frame contained time, rawpoll
poll_by_time_3 <- data.frame( 
  start_time = start_time,
  end_time = end_time,
  clinton = prop_raw_clinton,
  trump = prop_raw_trump,
  johnson = prop_raw_johnson
)

head(poll_by_time_3)
```

3 candidates data removing the missing values:

```{r}
# Remove the missing values
poll_by_time_clean_3 <- na.omit(poll_by_time_3)
head(poll_by_time_clean_3)
# Ordered by end_data
poll_by_time_clean_3 <- poll_by_time_clean_3[order(poll_by_time_clean_3$end_time, decreasing = FALSE),]
head(poll_by_time_clean_3)
# Count the number of row for cleaned 3 candidates data
nrow(poll_by_time_clean_3)

start_time_clean_3 <- as.POSIXct(poll_by_time_clean_3$start_time)
end_time_clean_3 <- as.POSIXct(poll_by_time_clean_3$end_time)
prop_raw_clinton_clean_3 <- poll_by_time_clean_3$clinton
prop_raw_trump_clean_3 <- poll_by_time_clean_3$trump
prop_raw_johnson_clean_3 <- poll_by_time_clean_3$johnson
```

Using the data with missing values deleted, a trend chart showing the change in the proportion of votes obtained by 3 candidates (Clinton, Trump and Johnson) over time is made.

```{r, echo=FALSE}
g_4 <- ggplot(poll_by_time_clean_3, aes(x = end_time_clean_3)) +
  geom_smooth(aes(y = prop_raw_clinton_clean_3, color = "Clinton")) +
  geom_smooth(aes(y = prop_raw_trump_clean_3, color = "Trump")) +
  geom_smooth(aes(y = prop_raw_johnson_clean_3, color = "Johnson")) +
  labs(x = "Date", y = "Proportion of rawpoll (%)", 
       title = "Raw Poll Proportion Trend by Time", 
       subtitle = "Clinton vs. Trump vs. Johnson", 
       caption = "Data: poll_by_time_clean_3 (without Missing Values)") +
  scale_color_manual(values = c("Clinton" = "blue", "Trump" = "red", "Johnson" = "green")) +
  scale_x_datetime(date_breaks = "2 month") +
  theme(axis.text.x = element_text(angle = 50, size = 7, vjust = 0.5)) + 
  theme(axis.title.x = element_text(size = 9, vjust = 0),
        axis.title.y = element_text(size = 9, vjust = 3)) +
  theme(plot.title = element_text(size = 12, face = "bold", 
                                  margin = margin(0, 0, 0, 0))) +
  theme(legend.title = element_blank()) +
  theme(legend.position = "bottom")
print(g_4)
```

2 candidate's (Clinton, Trump) trend by time with cleaned data.

```{r}
#Create 2 candidates frame contained time, rawpoll
poll_by_time_2 <- data.frame( 
  start_time = start_time,
  end_time = end_time,
  clinton = prop_raw_clinton,
  trump = prop_raw_trump
)

head(poll_by_time_2)
```

2 candidates data removing the missing values:

```{r, echo=FALSE}
# Remove the missing values
poll_by_time_clean_2 <- na.omit(poll_by_time_2)
head(poll_by_time_clean_2)
# Ordered by end_data
poll_by_time_clean_2 <- poll_by_time_clean_2[order(poll_by_time_clean_2$end_time, decreasing = FALSE),]
head(poll_by_time_clean_2)
tail(poll_by_time_clean_2)
# Count the number of row for cleaned 2 candidates data
nrow(poll_by_time_clean_2)

start_time_clean_2 <- as.POSIXct(poll_by_time_clean_2$start_time)
end_time_clean_2 <- as.POSIXct(poll_by_time_clean_2$end_time)
prop_raw_clinton_clean_2 <- poll_by_time_clean_2$clinton
prop_raw_trump_clean_2 <- poll_by_time_clean_2$trump
```

Using the data with missing values deleted, a trend chart showing the change in the proportion of votes obtained by 2 candidates (Clinton vs. Trump) over time is made.

```{r, echo=FALSE}
g_5 <- ggplot(poll_by_time_clean_2, aes(x = end_time_clean_2)) +
  geom_smooth(aes(y = prop_raw_clinton_clean_2, color = "Clinton")) +
  geom_smooth(aes(y = prop_raw_trump_clean_2, color = "Trump")) +
  labs(x = "Date", y = "Proportion of rawpoll (%)", 
       title = "Raw Proportion Trend by Time", 
       subtitle = "Clinton vs. Trump", 
       caption = "Data: poll_by_time_clean_2 (without Missing Values)") +
  scale_color_manual(values = c("Clinton" = "blue", "Trump" = "red")) +
  scale_x_datetime(date_breaks = "2 month") +
  theme(axis.text.x = element_text(angle = 50, size = 7, vjust = 0.5)) + 
  theme(axis.title.x = element_text(size = 9, vjust = 0),
        axis.title.y = element_text(size = 9, vjust = 3)) + 
  theme(plot.title = element_text(size = 12, face = "bold", 
                                  margin = margin(0, 0, 0, 0))) +
  theme(legend.title = element_blank()) +
  theme(legend.position = "bottom")
print(g_5)
```

Explore population types tend to vote for Clinton with population variable:

```{r}
#Create frame contained time, rawpoll, grade
population <- ElectionPoll$population

poll_by_time_population <- data.frame( 
  start_time = start_time,
  end_time = end_time,
  clinton = prop_raw_clinton,
  trump = prop_raw_trump,
  johnson = prop_raw_johnson,
  mcmullin = prop_raw_mcmullin,
  population = population
)

head(poll_by_time_population)
# Order with increasing end_date
poll_by_time_population <- poll_by_time_population[order(poll_by_time_population$end_time, decreasing = FALSE),]
head(poll_by_time_population)
```

Scatter plot for population distribution tend to Clinton:

```{r}
# Plot population tend to Clinton
g_6 <- ggplot(poll_by_time_population, aes(x = end_time, color = population)) +
  geom_point(aes(y = prop_raw_clinton),size = 1, alpha = 0.7) +
  labs(x = "Date", y = "Proportion of rawpoll (%)", 
       title = "Population type distribution 
       tend to Clinton") +
  scale_x_datetime(date_breaks = "2 month") +
  scale_color_manual(values = c("dodgerblue4", "darkolivegreen4", 
                                      "darkorchid3", "goldenrod1")) +
  theme(axis.text.x = element_text(angle = 50, size = 7, vjust = 0.5)) + 
  theme(axis.title.x = element_text(size = 9, vjust = 0),
        axis.title.y = element_text(size = 9, vjust = 3)) +
  theme(plot.title = element_text(size = 12, face = "bold", 
                                  margin = margin(0, 0, 0, 0))) + 
  theme(legend.position = "bottom") +
  expand_limits(y = 0)
```

Scatter plot for population distribution tend to Trump:

```{r}
# Plot population tend to Trump
g_7 <- ggplot(poll_by_time_population, aes(x = end_time, color = population)) +
  geom_point(aes(y = prop_raw_trump),size = 1, alpha = 0.7) +
  labs(x = "Date", y = "Proportion of rawpoll (%)", 
       title = "Population type distribution 
       tend to Trump", 
       caption = "Data: poll_by_time_population") +
  scale_x_datetime(date_breaks = "2 month") +
  scale_color_manual(values = c("dodgerblue4", "darkolivegreen4", 
                                      "darkorchid3", "goldenrod1")) +
  theme(axis.text.x = element_text(angle = 50, size = 7, vjust = 0.5)) + 
  theme(axis.title.x = element_text(size = 9, vjust = 0),
        axis.title.y = element_text(size = 9, vjust = 3)) +
  theme(plot.title = element_text(size = 12, face = "bold", 
                                  margin = margin(0, 0, 0, 0)))  +
  theme(legend.position = "bottom") +
  expand_limits(y = 0)
```

Scatter plot for population distribution tend to Johnson:

```{r}
# Plot population tend to Johnson
g_8 <- ggplot(poll_by_time_population, aes(x = end_time, color = population)) +
  geom_point(aes(y = prop_raw_johnson),size = 1, alpha = 0.7) +
  labs(x = "Date", y = "Proportion of rawpoll (%)", 
       title = "Population type distribution 
       tend to Johnson") +
  scale_x_datetime(date_breaks = "2 month") +
  scale_color_manual(values = c("dodgerblue4", "darkolivegreen4", 
                                      "darkorchid3", "goldenrod1")) +
  theme(axis.text.x = element_text(angle = 50, size = 7, vjust = 0.5)) + 
  theme(axis.title.x = element_text(size = 9, vjust = 0),
        axis.title.y = element_text(size = 9, vjust = 3)) +
  theme(plot.title = element_text(size = 12, face = "bold", 
                                  margin = margin(0, 0, 0, 0))) + 
  theme(legend.position = "bottom") +
  expand_limits(y = 0)
```

Scatter plot for population distribution tend to Mcmullin::

```{r}
# Plot population tend to Johnson
g_9 <- ggplot(poll_by_time_population, aes(x = end_time, color = population)) +
  geom_point(aes(y = prop_raw_mcmullin),size = 1, alpha = 0.7) +
  labs(x = "Date", y = "Proportion of rawpoll (%)", 
       title = "Population type distribution 
       tend to Mcmullin", 
       caption = "Data: poll_by_time_population") +
  scale_x_datetime(date_breaks = "2 month") +
  scale_color_manual(values = c("dodgerblue4", "darkolivegreen4", 
                                      "darkorchid3", "goldenrod1")) +
  theme(axis.text.x = element_text(angle = 50, size = 7, vjust = 0.5)) + 
  theme(axis.title.x = element_text(size = 9, vjust = 0),
        axis.title.y = element_text(size = 9, vjust = 3)) +
  theme(plot.title = element_text(size = 12, face = "bold", 
                                  margin = margin(0, 0, 0, 0))) + 
  theme(legend.position = "bottom") +
  expand_limits(y = 0)
```

```{r}
print(g_6 + g_7)
print(g_8 + g_9)
```

By states:

```{r}
#Create frame contained state, vote number for each candidate
states <- ElectionPoll$state
prop_raw_clinton <- ElectionPoll$rawpoll_clinton
prop_raw_trump <- ElectionPoll$rawpoll_trump
prop_raw_johnson <- ElectionPoll$rawpoll_johnson
prop_raw_mcmullin <- ElectionPoll$rawpoll_mcmullin
size <- ElectionPoll$samplesize

poll_by_state <- data.frame(
  state = states,
  prop_clinton = prop_raw_clinton,
  prop_trump = prop_raw_trump,
  prop_johnson = prop_raw_johnson,
  prop_mcmullin = prop_raw_mcmullin,
  size = size,
  NumVote_clinton = size * (prop_raw_clinton/100),
  NumVote_trump = size * (prop_raw_trump/100),
  NumVote_johnson = size * (prop_raw_johnson/100),
  NumVote_mcmullin = size * (prop_raw_mcmullin/100)
)
poll_by_state[is.na(poll_by_state)] <- 0
head(poll_by_state)
```
```{r}
NumVote_State <- cbind(poll_by_state$state, poll_by_state$NumVote_clinton, 
      poll_by_state$NumVote_trump, poll_by_state$NumVote_johnson, 
      poll_by_state$NumVote_mcmullin)
colnames(NumVote_State) <- c("state","Clinton", "Trump", "Johnson", "Mcmullin")
View(NumVote_State)
```

```{r}
NumVoteState <- as.data.frame(NumVote_State) %>%
  pivot_longer(cols = -state,
               names_to = "candidate",
               values_to = "PollNumber")
NumVoteState$PollNumber <- as.numeric(NumVoteState$PollNumber)
View(NumVoteState)
```

Clinton total raw polls by state:

```{r}
# Clinton total raw polls by state:
poll_clinton <- filter(NumVoteState, candidate == "Clinton")
clinton_state <- poll_clinton %>%
  group_by(state) %>%
  summarize(ClintonPolls = sum(PollNumber))
head(clinton_state)
```

Trump total raw polls by state:

```{r}
# Trump total raw polls by state:
poll_trump <- filter(NumVoteState, candidate == "Trump")
Trump_state <- poll_trump %>%
  group_by(state) %>%
  summarize(TrumpPolls = sum(PollNumber))
head(Trump_state)
```

Johnson total raw polls by state:

```{r}
# Johnson total raw polls by state:
poll_johnson <- filter(NumVoteState, candidate == "Johnson")
Johnson_state <- poll_johnson %>%
  group_by(state) %>%
  summarize(JohnsonPolls = sum(PollNumber))
head(Johnson_state)
```

Mcmullin total raw polls by state:

```{r}
# Mcmullin total raw polls by state:
poll_mcmullin <- filter(NumVoteState, candidate == "Mcmullin")
Mcmullin_state <- poll_mcmullin %>%
  group_by(state) %>%
  summarize(McmullinPolls = sum(PollNumber))
head(Mcmullin_state)
```

```{r}
g_10 <- ggplot(data = NumVoteState, mapping = aes( x = state, fill = candidate)) +
  geom_col(aes(y = PollNumber),position='stack') +
  labs(x = "State", y = "Number of Polls", 
       title = "Poll Count by States", 
       caption = "Data: NumVoteState") +
  scale_fill_manual(values=c("Clinton" = "blue", "Trump" = "red", 
                             "Johnson" = "green", "Mcmullin" = "yellow")) +
  #geom_text(stat='Count',aes(label=after_stat(count)), color = "White", 
            #size=3, position = position_stack(0.5)) + 
  theme(axis.text.x = element_text(angle = 50, size = 6, vjust = 0.5)) + 
  theme(axis.title.x = element_text(size = 9, vjust = 0),
        axis.title.y = element_text(size = 9, vjust = 3)) + 
  theme(plot.title = element_text(size = 12, face = "bold", 
                                  margin = margin(0, 0, 0, 0))) +
  theme(legend.position = "bottom")
print(g_10)
```

If we ignore U.S., focus on the polls on each state:

```{r}
NumVoteState_dropUS <- NumVoteState[!NumVoteState$state %in% "U.S.", ]

g_12 <- ggplot(data = NumVoteState_dropUS, mapping = aes( x = state, fill = candidate)) +
  geom_col(aes(y = PollNumber),position='stack') +
  labs(x = "State", y = "Number of Polls", 
       title = "Poll Count by States", 
       caption = "Data: NumVoteState_dropUS") +
  scale_fill_manual(values=c("Clinton" = "blue", "Trump" = "red", 
                             "Johnson" = "green", "Mcmullin" = "yellow")) +
  #geom_text(stat='Count',aes(label=after_stat(count)), color = "White", 
            #size=3, position = position_stack(0.5)) + 
  theme(axis.text.x = element_text(angle = 50, size = 6, vjust = 0.5)) + 
  theme(axis.title.x = element_text(size = 9, vjust = 0),
        axis.title.y = element_text(size = 9, vjust = 3)) + 
  theme(plot.title = element_text(size = 12, face = "bold", 
                                  margin = margin(0, 0, 0, 0))) +
  theme(legend.position = "bottom")
print(g_12)
```


```{r}
g_11 <- ggplot(data = NumVoteState, mapping = aes( x = state, fill = candidate)) +
  geom_col(aes(y = PollNumber),position='fill') +
  labs(x = "State", y = "Percentage of Polls", 
       title = "Poll Percentage by States", 
       caption = "Data: NumVoteState") +
  scale_fill_manual(values=c("Clinton" = "blue", "Trump" = "red", 
                             "Johnson" = "green", "Mcmullin" = "yellow")) +
  #geom_text(stat='Count',aes(label=after_stat(count)), color = "White", 
            #size=3, position = position_stack(0.5)) + 
  theme(axis.text.x = element_text(angle = 50, size = 6, vjust = 0.5)) + 
  theme(axis.title.x = element_text(size = 9, vjust = 0),
        axis.title.y = element_text(size = 9, vjust = 3)) + 
  theme(plot.title = element_text(size = 12, face = "bold", 
                                  margin = margin(0, 0, 0, 0))) +
  theme(legend.position = "bottom")
print(g_11)
```

